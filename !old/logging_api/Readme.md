
# fetch_logging.py ドキュメント

このドキュメントは、OpenShift Loki API からログを取得するための `fetch_logging.py` スクリプトについての概要と説明を提供します。



## 目次

- [前提](#前提)
- [概要](#概要)
- [依存関係](#依存関係)
- [スクリプトのワークフロー](#スクリプトのワークフロー)
- [使用方法](#使用方法)
- [引数](#引数)
- [出力](#出力)
- [エラーハンドリング](#エラーハンドリング)

---

## 前提

* OpenShiftに、`OpenShift Logging Operator` と `Loki Operator` をインストールし、`Loki Stack` にログ転送する仕組みを構築する必要があります。

## 概要

`fetch_logging.py` スクリプトは、OpenShift Loki API と連携して、特定のコンテナやネームスペースに関連するログを取得します。タイムレンジ、コンテナ名、ネームスペース、クエリ間隔に基づいてログをクエリするための様々なオプションをサポートしています。

## 依存関係

このスクリプトは、以下の Python ライブラリに依存しています：
- `requests`: Loki API への HTTP リクエストを送信するため。
- `argparse`: コマンドライン引数を処理するため。
- `json`: JSON データを解析および保存するため。
- `datetime`: タイムレンジを処理するため。
- `os`: ファイルシステム操作を処理するため。

必要なライブラリをインストールするには、以下を実行してください：
```bash
pip install requests
```

---

## スクリプトのワークフロー

1. **コマンドライン引数の解析**：
   Loki API エンドポイント、トークン、ネームスペース、コンテナ名などのコマンドライン引数を `argparse` を使用して解析します。

2. **Loki API のクエリ**：
   `get_loki_logs` 関数が、指定されたパラメータで Loki API エンドポイントに HTTP GET リクエストを送信します。

3. **ログをファイルに保存**：
   取得したログは、`logs` ディレクトリ内の JSON ファイルに保存されます。ファイル名には、ログが取得されたタイムスタンプが含まれます。

4. **ターミナルへのログ出力**：
   ログを整形してターミナルに出力し、読みやすい形式で表示します。

---

## 使用方法

以下のようにスクリプトを実行します：
```bash
python fetch_logging.py <LOKI_API> <TOKEN> [OPTIONS]
```

### 実行例
```bash
python fetch_logging.py logging-loki-openshift-logging.apps.cluster-qcvgs.qcvgs.sandbox36.opentlc.com sha256~TGC4E6iN1OGOGe7hv0MyAZsAqdjVgwZFrANwnR8AiDY
```

---

## 引数

スクリプトは、以下の引数を受け付けます：

| 引数                 | 説明                                                                                       | デフォルト           |
|----------------------|-------------------------------------------------------------------------------------------|---------------------|
| `LOKI_API`           | Loki API エンドポイント (例: `logging-loki.<domain>`)。                                   | 必須                 |
| `TOKEN`              | 認証用の Bearer トークン。                                                                | 必須                 |
| `--namespace`        | 取得するログのネームスペース。                                                            | `petstore`          |
| `--container`        | 取得するログのコンテナ名。                                                                | `petstore-demo`     |
| `--start-minutes-ago`| 何分前からログを取得するかを指定。                                                        | `1`                 |
| `--step`             | クエリのステップ間隔 (例: `5s`) 。                                                        | `5s`                |
| `--output-prefix`    | 出力されるログファイルのプレフィックス。                                                  | `logs`              |

`LOKI_API` と `TOKEN` は `oc` コマンドを使って以下のように取得できます。

```
export LOKI_API=$(oc get route logging-loki -n openshift-logging -o jsonpath='{.spec.host}')
export TOKEN=$(oc whoami --show-token)
```

---

## 出力

### トップレベル構造

Loki API のレスポンスは以下の構造を持ちます：

| キー        | 型        | 説明                                                                                   |
|-------------|-----------|---------------------------------------------------------------------------------------|
| `status`    | `string`  | リクエストのステータス (例: `"success"`) 。                                            |
| `data`      | `object`  | メインデータを含むオブジェクト。                                                       |

---

### `data` オブジェクト

`data` オブジェクトには以下のプロパティが含まれます：

| キー            | 型        | 説明                                                                                   |
|-----------------|-----------|---------------------------------------------------------------------------------------|
| `resultType`    | `string`  | データのタイプ (例: `"streams"`) 。                                                    |
| `result`        | `array`   | ログストリームを表すオブジェクトの配列。                                               |

---

### `result` 配列内のオブジェクト

`result` 配列内の各オブジェクトは以下の構造を持ちます：

| キー       | 型        | 説明                                                                                   |
|------------|-----------|---------------------------------------------------------------------------------------|
| `stream`   | `object`  | ログストリームに関連するメタデータ。                                                   |
| `values`   | `array`   | ログエントリを表す配列。                                                               |

#### `stream` オブジェクト

`stream` オブジェクトには以下のプロパティが含まれます：

| キー                          | 型        | 説明                                                                                   |
|-------------------------------|-----------|---------------------------------------------------------------------------------------|
| `kubernetes_container_name`   | `string`  | ログを生成したコンテナの名前。                                                         |
| `kubernetes_namespace_name`   | `string`  | コンテナが属する Kubernetes ネームスペースの名前。                                     |
| `kubernetes_pod_name`         | `string`  | ログを生成した Pod の名前。                                                           |
| `log_type`                    | `string`  | ログの種類 (例: `"application"`) 。                                                    |

---

#### `values` 配列

`values` 配列は、ログのタイムスタンプとメッセージを格納した配列で、各要素は以下の形式を持ちます：

| インデックス | 型        | 説明                                                                                   |
|-------------|-----------|---------------------------------------------------------------------------------------|
| `0`         | `string`  | タイムスタンプ (UNIX ナノ秒形式)。                                                      |
| `1`         | `string`  | ログメッセージ (JSON 文字列の場合が多い)。                                               |

---

### メッセージの内部構造

`values` 配列内のメッセージは、多くの場合 JSON 文字列としてエンコードされており、以下のような情報を含みます：

| キー              | 型        | 説明                                                                                   |
|-------------------|-----------|---------------------------------------------------------------------------------------|
| `@timestamp`      | `string`  | ISO 8601 形式のタイムスタンプ。                                                        |
| `hostname`        | `string`  | ホスト名。                                                                            |
| `kubernetes`      | `object`  | Kubernetes に関連する情報 (例: Pod 名、コンテナ ID、ラベルなど)。                       |
| `message`         | `string`  | 実際のログメッセージ。                                                                |
| `level`           | `string`  | ログのレベル (例: `"default"`) 。                                                      |

---

### 具体例

以下は、`values` 配列の例です：

```json
[
  "1732253892961892912",
  "{"@timestamp":"2024-11-22T05:38:02.515707997Z","hostname":"ip-10-0-81-155.us-east-2.compute.internal","kubernetes":{"namespace_name":"petstore","pod_name":"postgresql-df8c6bd87-vtstz"},"message":"Starting server..."}"
]
```

### ログ出力

ログは `logs` ディレクトリに保存されます。出力ファイル名の形式は以下の通りです：
```
<output-prefix>_YYYYMMDDTHHMMSSZ.json
```

### 実行例
出力プレフィックスが `loki_raw` の場合、生成されるファイル名の例：
```
logs/loki_raw_20241122T051230Z.json
```

保存された JSON ファイルには、Loki API からの未加工のレスポンスが整形された形式で含まれています。

---

## エラーハンドリング

スクリプトには以下のエラー処理が含まれています：
- HTTP リクエストエラー (例: 認証エラー、ネットワークエラー)。
- ログ保存時のファイルシステムエラー。
- Loki API からの無効な JSON レスポンス。

エラーはターミナルに説明付きで出力されます。

---

## ディレクトリ構造

スクリプトは、`logs` ディレクトリが存在しない場合に自動的に作成します。ディレクトリ構造の例：
```
logs/
    loki_raw_20241122T051230Z.json
```

---

## 補足

- Loki API エンドポイントとトークンが正しく構成されていることを確認してください。
- このスクリプトは、利便性のために HTTPS 証明書検証を無効にしています。本番環境では、有効な CA 証明書を指定して検証を有効にすることを検討してください。

